<!DOCTYPE html>
<html lang="hu">
	<head>
	    <meta charset="utf-8">
	    <title>RoNoCa - Főoldal</title>
	    <!-- Load React Libraries -->
	    <!-- Note: when deploying, replace “development.js” with “production.min.js”. -->
		<script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  		<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
	    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
	</head>
	<body>
		<h1>valami</h1>
	    <div id="root"></div>
	    
	<!-- React component script -->
    <script type="text/babel">
        const predefinedColumnNames = [
            'Azonosító', 'km/h1', 'I_ak_kat_N', 'II_ak_kat_N', 'III_ak_kat_N', 'I_ak_kat_E', 'II_ak_kat_E', 'III_ak_kat_E',
            'R_Azonosító', 'R_km/h1', 'R_I_ak_kat_N', 'R_II_ak_kat_N', 'R_III_ak_kat_N', 'R_I_ak_kat_E', 'R_II_ak_kat_E', 'R_III_ak_kat_E'
        ];

   		const FileUploadComponent = () => {
    const [file, setFile] = React.useState(null);
    const [attributeData, setAttributeData] = React.useState([]);
    const [columnNames, setColumnNames] = React.useState([]);

    const handleFileChange = (event) => {
        const selectedFile = event.target.files[0];
        setFile(selectedFile);
    };

    const filterTableBySelectedColumns = () => {
        const filteredData = attributeData.map((row) => {
            const newRow = {};
            
       let selectedColumnIndex = 0;

        Object.keys(row).forEach((key, index) => {
            const selectedColumn = columnNames[selectedColumnIndex];
            if (selectedColumn && selectedColumn !== 'Select Column Name') {
				console.log('New column names:', columnNames);
				
                newRow[selectedColumn] = row[key];
                
            }
            selectedColumnIndex++;
            
            
       /*     columnNames.forEach((selectedColumn, index) => {
                if (selectedColumn !== '') {
                    const originalColumn = Object.keys(row)[index];
                    console.log('New column names:', columnNames);
                    newRow[selectedColumn] = row[originalColumn];
                }*/
            });
            console.log('NewRow:', newRow);
            return newRow;
        });
        return filteredData;
    };

    const handleFileUpload = async () => {
        const formData = new FormData();
        formData.append('zipFile', file);

        try {
			console.log('FileLoad Request Data:', formData);
            const response = await fetch('/console/fileLoad', {
                method: 'POST',
                body: formData,
            });

            if (response.ok) {
                const data = await response.json();
                console.log('FileLoad Response Data:', data);
                setAttributeData(data);
                setColumnNames(Array(data[0] ? Object.keys(data[0]) : []).fill(''));
            } else {
                console.error('Failed to upload file');
            }
        } catch (error) {
            console.error('Error uploading file:', error);
        }
    };

    const handleSelectChange = (index) => (event) => {
        const updatedColumnNames = [...columnNames];
        updatedColumnNames[index] = event.target.value;
        setColumnNames(updatedColumnNames);
    };

    const handleFilterClick = async () => {
        const filteredData = filterTableBySelectedColumns();

        try {
			console.log('SaveToDatabase Request Data:', filteredData);
            const response = await fetch('/console/saveToDatabase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filteredData),
            });

            if (response.ok) {
				console.log('SaveToDatabase Response:', await response.text());
                console.log('Data filtered and sent to backend successfully');
                // Optionally handle success here
            } else {
                console.error('Failed to filter data');
            }
        } catch (error) {
            console.error('Error filtering data:', error);
        }
    };

    return (
        <div>
            <h1>KONZOL OLDAL</h1>
            <input type="file" accept=".zip" onChange={handleFileChange} />
            <button onClick={handleFileUpload}>Upload</button>

            <table>
                <thead>
		                    <tr>
		                        {attributeData.length > 0 &&
		                            Object.keys(attributeData[0]).map((key, index) => (
		                                <th key={key}>
		                                    <div>
		                                        <span>{key}</span>
		                                        <select value={columnNames[index]} onChange={handleSelectChange(index)}>
		                                            <option value="">Select Column Name</option>
		                                            {predefinedColumnNames.map((name, idx) => (
		                                                <option key={idx} value={name}>
		                                                    {name}
		                                                </option>
		                                            ))}
		                                        </select>
		                                    </div>
		                                </th>
		                            ))}
		                    </tr>
		                </thead>
		                <tbody>
		                    {attributeData.map((row, rowIndex) => (
		                        <tr key={rowIndex}>
		                            {Object.values(row).map((value, columnIndex) => (
		                                <td key={columnIndex}>{value}</td>
		                            ))}
		                        </tr>
		                    ))}
		                </tbody>

            </table>

            <button onClick={handleFilterClick}>Filter</button>
        </div>
    );
};

ReactDOM.render(<FileUploadComponent />, document.getElementById('root'));
    </script>
	
	</body>
</html>
